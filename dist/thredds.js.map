{"version":3,"sources":["../src/thredds.js"],"names":["moment","mapboxgl","d3","XmlConverter","Plotly","Thredds","ctrl","mapContainer","createMap","frames","currentFrameIndex","animation","time","frameIndex","stopAnimation","stepFrame","mapCenterLonLat","parseFloat","panel","mapCenterLongitude","mapCenterLatitude","accessToken","mbApiKey","map","Map","container","style","mapStyle","center","zoom","initialZoom","interactive","userInteractionEnabled","onclick","onClick","self","on","e","n","Math","round","data","lat","lngLat","lng","from","to","length","ql","thredds","parameter","options","REQUEST","ELEVATION","TRANSPARENT","STYLES","COLORSCALERANGE","NUMCOLORBANDS","LOGSCALE","SERVICE","VERSION","SRS","CRS","FORMAT","INFO_FORMAT","BBOX","join","X","Y","WIDTH","HEIGHT","TIME","QUERY_LAYERS","LAYERS","url","URL","search","URLSearchParams","window","$","ajax","type","contentType","dataType","success","res","result","xml2js","compact","FeatureInfoResponse","FeatureInfo","graphData","name","x","_text","y","value","document","getElementById","display","newPlot","title","text","margin","l","r","t","b","responsive","showLink","displayLogo","displayModeBar","fail","console","log","render","legend","needToRedrawFrames","clearFrames","createFrames","startAnimation","forEach","item","getLayer","removeLayer","dataCharacteristics","timeValues","loaded","createFramesSafely","attemptsLeft","interval","setInterval","clearInterval","frameName","wmsUrl","scale_min","scale_max","getSource","addSource","tiles","width","height","includes","push","slider","select","id","attr","goToIndex","oldFrame","newFrame","newLayer","source","paint","addLayer","format","property","resize","panTo","mapCenterMoved","zoomFactor","setZoom","parseInt","remove"],"mappings":"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","file":"thredds.js","sourcesContent":["/* eslint-disable id-length, no-unused-vars */\nimport moment from 'moment';\nimport mapboxgl from './libs/mapbox-gl';\nimport * as d3 from './libs/d3';\nimport XmlConverter from \"./libs/xml-js\";\nimport Plotly from './libs/plotly';\n\n/* eslint-disable id-length, no-unused-vars */\n\nexport default class Thredds {\n    constructor(ctrl, mapContainer) {\n        // console.log('NEW constructor')\n        this.ctrl = ctrl;\n        this.mapContainer = mapContainer;\n        this.createMap();\n        this.frames = []; // list of timestamps\n        this.currentFrameIndex = 0;\n        this.animation = {};\n        this.time = null;\n    }\n\n    setFrame(frameIndex)\n    {\n        if (this.animation) {\n            this.stopAnimation();\n        }\n        this.currentFrameIndex = frameIndex - 1;\n        this.stepFrame();\n    }\n\n    createMap() {\n        // console.log('rebuilding map');\n        const mapCenterLonLat = [parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)];\n        mapboxgl.accessToken = this.ctrl.panel.mbApiKey;\n        this.map = new mapboxgl.Map({\n            container: this.mapContainer,\n            style: 'mapbox://styles/mapbox/' + this.ctrl.panel.mapStyle,\n            center: mapCenterLonLat,\n            zoom: parseFloat(this.ctrl.panel.initialZoom),\n            interactive: this.ctrl.panel.userInteractionEnabled\n        });\n        const onclick = this.onClick,\n        self = this;\n        this.map.on('click', function (e) {\n            onclick(e,self);\n        });\n\n    }\n\n    round(n) {\n        return Math.round(n*1000)/1000\n    }\n\n    onClick(e,self) {\n        const data = {\n            lat: e.lngLat.lat,\n            lng: e.lngLat.lng,\n            from: self.frames[0],\n            to: self.frames[self.frames.length-1],\n            ql: self.ctrl.panel.thredds.parameter\n        }\n        const options = {\n            REQUEST: 'GetFeatureInfo',\n            ELEVATION: '0',\n            TRANSPARENT: 'true',\n            STYLES: 'boxfill/rainbow',\n            COLORSCALERANGE: '-50,50',\n            NUMCOLORBANDS: '20',\n            LOGSCALE: 'false',\n            SERVICE: 'WMS',\n            VERSION: '1.1.1',\n            SRS: 'EPSG:4326',\n            CRS: 'EPSG:4326',\n            FORMAT: 'image/png',\n            INFO_FORMAT: 'text/xml',\n            BBOX: [\n                e.lngLat.lng - 0.002,\n                e.lngLat.lat - 0.002,\n                e.lngLat.lng + 0.002,\n                e.lngLat.lat + 0.002,\n            ].join(','),\n            X: 1,\n            Y: 1,\n            WIDTH: 2,\n            HEIGHT: 2,\n            TIME: `${self.frames[0]}/${self.frames[self.frames.length-1]}`,\n            QUERY_LAYERS: self.ctrl.panel.thredds.parameter,\n            LAYERS: self.ctrl.panel.thredds.parameter,\n        }\n        const url = new URL(self.ctrl.panel.thredds.url)\n        url.search = new URLSearchParams(options)\n        // console.log(url.toString());\n\n        window.$.ajax({\n          type: 'GET',\n          url: url,\n          contentType: 'application/xml',\n          dataType: 'text',\n          success: (res) => {\n             const result = XmlConverter.xml2js(res, { compact : true }).FeatureInfoResponse.FeatureInfo;\n             self.graphData = {\n                 name: `${self.ctrl.panel.thredds.parameter} - lat ${self.round(e.lngLat.lat)} lon ${self.round(e.lngLat.lng)}`,\n                 x: result.map(function (x) {\n                    return x.time._text\n                 }),\n                 y: result.map(function (x) {\n                    return x.value._text !== 'none' ? self.round(x.value._text) : null\n                 }),\n                type: 'scatter',\n             }\n             document.getElementById(\"graphcontainer\").style.display = \"block\";\n              Plotly.newPlot(\n                  'graph',\n                  [self.graphData],\n                  {title: {text: self.graphData.name}, margin: {l:40,r:10,t:40,b:40}},\n                  {responsive: true,showLink: false,displayLogo: false,displayModeBar: false}\n              );\n          }\n        }).fail((res) => {\n          console.log('error in ajax: ', res);\n          this.thredds = null;\n          this.render();\n        });\n    // }\n\n    }\n\n    createLegend() {\n        this.legend = {};\n    }\n\n    needToRedrawFrames() {\n        this.legend = {};\n        return true;\n    }\n\n    drawLayerFrames() {\n        const data = this.ctrl.data;\n        if (this.needToRedrawFrames(data)) {\n            // console.log('needToRedrawFrames')\n            this.stopAnimation();\n            this.clearFrames();\n            this.createFrames(data);\n            // this.setFrame(0);\n            this.startAnimation();\n        }\n    }\n\n    clearFrames() {\n        this.frames.forEach((item) => {\n            if (this.map.getLayer('f-' + item))\n                this.map.removeLayer('f-' + item);\n        });\n        this.frames = [];\n    }\n\n    createFrames() {\n        // console.log('createFrames')\n        if (!this.ctrl.dataCharacteristics.timeValues) {\n            // console.log('no series to display');\n            return;\n        }\n\n        if (!this.ctrl.thredds) {\n            // console.log('no thredds data');\n            return;\n        }\n\n        if (this.map.loaded()) {\n            this.createFramesSafely();\n        } else {\n            // console.log('no geo source in map. maybe not loaded?');\n            // this is stupid to use setInterval.\n            // but mapbox doesn't seem to have a on-source-loaded event that reliably works\n            // for this purpose.\n            let attemptsLeft = 10;\n            const interval = setInterval(() => {\n                // console.log('waited for layer to load.');\n                if (this.map.loaded()) {\n                    this.createFramesSafely();\n                    clearInterval(interval);\n                } else {\n                    // console.log('still no geo source. try refresh manually?');\n                    if (--attemptsLeft <= 0) {\n                        clearInterval(interval);\n                    }\n                }\n            }, 500);\n        }\n    }\n\n    createFramesSafely() {\n        // console.log('createFramesSafely')\n        // console.log('createFramesSafely',this.ctrl.dataCharacteristics.timeValues)\n        this.ctrl.dataCharacteristics.timeValues.forEach((time) => {\n            // console.log(time)\n            // console.log(this.ctrl.panel.thredds)\n            const frameName = 'f-' + time;\n            const wmsUrl = `${this.ctrl.panel.thredds.url}?LAYERS=${this.ctrl.panel.thredds.parameter}&ELEVATION=0&TIME=${time}&TRANSPARENT=true&STYLES=boxfill%2Fsst_36&COLORSCALERANGE=${this.ctrl.panel.thredds.scale_min},${this.ctrl.panel.thredds.scale_max}&NUMCOLORBANDS=80&LOGSCALE=false&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&FORMAT=image%2Fpng&SRS=EPSG%3A3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256`;\n            // console.log('wmsUrl', wmsUrl);\n            if (this.map) {\n                if (!this.map.getSource('f-' + time))\n                    this.map.addSource('f-' + time, {\n                        type: 'raster',\n                        tiles: [wmsUrl],\n                        width: 256,\n                        height: 256\n                    });\n            }\n\n            if(!this.frames.includes(time))\n                this.frames.push(time);\n        });\n\n        // get slider component, set min/max/value\n        const slider = d3.select('#map_' + this.ctrl.panel.id + '_slider')\n            .attr('min', 0)\n            .attr('max', (this.frames.length -1))\n        ;\n    }\n\n\n    startAnimation() {\n        if (this.animation) {\n            this.stopAnimation();\n        }\n\n        this.animation = setInterval(() => {\n            this.stepFrame();\n        }, 3000);\n    }\n\n    stopAnimation() {\n        clearInterval(this.animation);\n        this.animation = null;\n    }\n\n    pauseAnimation() {\n        clearInterval(this.animation);\n        // this.animation = null;\n    }\n\n    stepFrame(goToIndex) {\n        // console.log('stepFrame', this.frames.length, this.currentFrameIndex)\n        if (!this.map) {\n            return;\n        }\n        if (this.frames.length === 0) {\n            // console.log('skipping animation: no frames');\n            return;\n        }\n        const oldFrame = 'f-' + this.frames[this.currentFrameIndex];\n\n        if(!goToIndex && goToIndex !== 0) {\n            this.currentFrameIndex += 1;\n        } else {\n            this.currentFrameIndex = goToIndex;\n        }\n        if (this.currentFrameIndex >= this.frames.length) {\n            this.currentFrameIndex = 0;\n        }\n        const newFrame = 'f-' + this.frames[this.currentFrameIndex];\n\n        // console.log(newFrame, oldFrame)\n        if(this.map.getLayer(oldFrame)) {\n            this.map.removeLayer(oldFrame);\n        }\n        const newLayer = {\n            id: newFrame,\n            type: 'raster',\n            source: newFrame,\n            paint: {\n                \"raster-opacity\": 1,\n            },\n        }\n        this.map.addLayer(newLayer);\n        this.time = this.frames[this.currentFrameIndex]\n        // this.map.setPaintProperty(newFrame, 'raster-opacity', 1);\n        // this.map.setPaintProperty(oldFrame, 'raster-opacity', 0);\n\n        // set time string in legend\n        d3.select('#map_' + this.ctrl.panel.id + '_date').text(moment(this.frames[this.currentFrameIndex]).format('DD-MM-YYYY HH:mm'));\n        // set slider position to indicate time-location\n        d3.select('#map_' + this.ctrl.panel.id + '_slider').property('value', this.currentFrameIndex);\n    }\n\n    resize() {\n        this.map.resize();\n    }\n\n    panToMapCenter() {\n        this.map.panTo([parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)]);\n        this.ctrl.mapCenterMoved = false;\n    }\n\n    setZoom(zoomFactor) {\n        this.map.setZoom(parseInt(zoomFactor, 10));\n    }\n\n    remove() {\n        if (this.map) {\n            this.map.remove();\n        }\n        this.map = null;\n    }\n}\n"]}